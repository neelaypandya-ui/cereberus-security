import { useEffect, useState } from 'react';
import { api } from '../services/api';
import { IntelCard } from './ui/IntelCard';

interface Vulnerability {
  category: string;
  severity: string;
  title: string;
  description: string;
  remediation: string;
  port?: number;
  service?: string;
}

interface ScanReport {
  scan_time?: string;
  total_findings: number;
  severity_counts?: Record<string, number>;
  vulnerabilities: Vulnerability[];
}

const SEVERITY_STAMPS: Record<string, { label: string; stampClass: string }> = {
  critical: { label: 'CRITICAL THREAT', stampClass: 'stamp-flash' },
  high: { label: 'HIGH PRIORITY', stampClass: 'stamp-immediate' },
  medium: { label: 'MODERATE RISK', stampClass: 'stamp-priority' },
  low: { label: 'LOW CONCERN', stampClass: 'stamp-routine' },
  info: { label: 'ADVISORY', stampClass: 'stamp-advisory' },
};

export function VulnerabilityPanel() {
  const [report, setReport] = useState<ScanReport | null>(null);
  const [scanning, setScanning] = useState(false);
  const [expandedIdx, setExpandedIdx] = useState<number | null>(null);

  useEffect(() => {
    loadReport();
  }, []);

  const loadReport = async () => {
    try {
      const data = await api.getVulnerabilityReport() as ScanReport;
      setReport(data);
    } catch { /* ignore */ }
  };

  const triggerScan = async () => {
    setScanning(true);
    try {
      const data = await api.triggerVulnerabilityScan() as ScanReport;
      setReport(data);
    } catch { /* ignore */ }
    setScanning(false);
  };

  const severityColor = (s: string) => {
    const map: Record<string, string> = {
      critical: 'var(--severity-critical)',
      high: 'var(--severity-high)',
      medium: 'var(--severity-medium)',
      low: 'var(--severity-low)',
      info: 'var(--severity-info)',
    };
    return map[s] || 'var(--text-muted)';
  };

  const grouped = report ? groupBy(report.vulnerabilities, 'category') : {};

  return (
    <IntelCard title="THREAT ASSESSMENT" classification="SECRET">
      {/* Header + Scan Button */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
        <div style={{ fontSize: '11px', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)', letterSpacing: '1px' }}>
          {report?.scan_time ? `LAST SCAN: ${new Date(report.scan_time).toLocaleTimeString('en-US', { hour12: false, timeZone: 'UTC' })} UTC` : 'NO SCAN DATA'}
        </div>
        <button
          onClick={triggerScan}
          disabled={scanning}
          style={{
            padding: '8px 20px',
            background: scanning ? 'var(--bg-tertiary)' : 'var(--red-dark)',
            border: `1px solid ${scanning ? 'var(--border-default)' : 'var(--red-primary)'}`,
            borderRadius: '2px',
            color: scanning ? 'var(--text-muted)' : '#fff',
            fontSize: '11px',
            fontFamily: 'var(--font-mono)',
            letterSpacing: '2px',
            cursor: scanning ? 'default' : 'pointer',
          }}
        >
          {scanning ? 'SCANNING...' : 'INITIATE THREAT SCAN'}
        </button>
      </div>

      {/* Severity Summary */}
      {report?.severity_counts && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px', marginBottom: '16px' }}>
          {['critical', 'high', 'medium', 'low'].map((sev) => (
            <div key={sev} className="instrument-readout">
              <span className="readout-label">{sev.toUpperCase()}</span>
              <span className="readout-value" style={{ color: severityColor(sev) }}>
                {report.severity_counts?.[sev] ?? 0}
              </span>
            </div>
          ))}
        </div>
      )}

      {/* Grouped Findings */}
      {Object.entries(grouped).map(([category, vulns], sectionIdx) => (
        <div key={category} style={{
          marginBottom: '12px',
          border: '1px solid var(--border-default)',
          borderRadius: '2px',
          overflow: 'hidden',
        }}>
          <div style={{
            padding: '10px 14px',
            background: 'var(--bg-tertiary)',
            borderBottom: '1px solid var(--border-default)',
            display: 'flex',
            justifyContent: 'space-between',
          }}>
            <span style={{
              fontSize: '11px',
              fontFamily: 'var(--font-mono)',
              fontWeight: 600,
              letterSpacing: '2px',
              color: 'var(--text-secondary)',
            }}>
              SECTION {toRoman(sectionIdx + 1)}: {category.toUpperCase().replace(/_/g, ' ')}
            </span>
            <span style={{ fontSize: '10px', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>
              {vulns.length} finding(s)
            </span>
          </div>
          {vulns.map((v: Vulnerability, i: number) => {
            const globalIdx = report!.vulnerabilities.indexOf(v);
            const isExpanded = expandedIdx === globalIdx;
            const stamp = SEVERITY_STAMPS[v.severity] || SEVERITY_STAMPS.info;
            return (
              <div
                key={i}
                onClick={() => setExpandedIdx(isExpanded ? null : globalIdx)}
                style={{
                  padding: '8px 14px',
                  borderBottom: '1px solid var(--border-default)',
                  cursor: 'pointer',
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span className={`stamp-badge ${stamp.stampClass}`}>{stamp.label}</span>
                  <span style={{ fontSize: '12px', color: 'var(--text-primary)', flex: 1 }}>{v.title}</span>
                  <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>{isExpanded ? '\u25B2' : '\u25BC'}</span>
                </div>
                {isExpanded && (
                  <div style={{ marginTop: '10px', paddingLeft: '10px' }}>
                    <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px', lineHeight: 1.5 }}>
                      {v.description}
                    </p>
                    <div style={{
                      fontSize: '11px',
                      fontFamily: 'var(--font-mono)',
                      padding: '10px 14px',
                      background: 'var(--bg-tertiary)',
                      borderRadius: '2px',
                      borderLeft: '3px solid var(--cyan-dark)',
                    }}>
                      <div style={{ fontSize: '9px', letterSpacing: '2px', color: 'var(--cyan-primary)', marginBottom: '4px' }}>
                        RECOMMENDED ACTION
                      </div>
                      <div style={{ color: 'var(--text-secondary)' }}>{v.remediation}</div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      ))}

      {report && report.vulnerabilities.length === 0 && (
        <div style={{
          textAlign: 'center',
          padding: '40px',
          color: 'var(--status-online)',
          fontFamily: 'var(--font-mono)',
          fontSize: '12px',
          letterSpacing: '2px',
        }}>
          NO VULNERABILITIES DETECTED
        </div>
      )}
    </IntelCard>
  );
}

function toRoman(n: number): string {
  const numerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
  return numerals[n - 1] || String(n);
}

function groupBy<T>(arr: T[], key: keyof T): Record<string, T[]> {
  const result: Record<string, T[]> = {};
  for (const item of arr) {
    const k = String(item[key]);
    if (!result[k]) result[k] = [];
    result[k].push(item);
  }
  return result;
}
