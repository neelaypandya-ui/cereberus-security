import { useEffect, useState } from 'react';
import { api } from '../services/api';
import { IntelCard } from './ui/IntelCard';

interface Vulnerability {
  category: string;
  severity: string;
  title: string;
  description: string;
  remediation: string;
  port?: number;
  service?: string;
}

interface ScanReport {
  scan_time?: string;
  total_findings: number;
  severity_counts?: Record<string, number>;
  vulnerabilities: Vulnerability[];
}

type NeutralizationStatus = 'idle' | 'confirming' | 'executing' | 'neutralized' | 'failed';

interface NeutralizationState {
  status: NeutralizationStatus;
  error?: string;
  details?: string;
}

const SEVERITY_STAMPS: Record<string, { label: string; stampClass: string }> = {
  critical: { label: 'CRITICAL THREAT', stampClass: 'stamp-flash' },
  high: { label: 'HIGH PRIORITY', stampClass: 'stamp-immediate' },
  medium: { label: 'MODERATE RISK', stampClass: 'stamp-priority' },
  low: { label: 'LOW CONCERN', stampClass: 'stamp-routine' },
  info: { label: 'ADVISORY', stampClass: 'stamp-advisory' },
};

const REMEDIABLE_CATEGORIES = ['open_port', 'guest_account', 'firewall', 'autologin'];

function getThreatBriefing(v: Vulnerability): {
  designation: string;
  attackVector: string;
  classification: string;
  detectionMethod: string;
  riskAssessment: string;
  proposedAction: string;
  reversibility: string;
} {
  const port = v.port;
  const service = v.service || 'Unknown';

  switch (v.category) {
    case 'open_port': {
      const serviceRisks: Record<string, string> = {
        'SMB': 'SMB (Server Message Block) exposes file sharing and can be exploited for lateral movement, credential theft (e.g., EternalBlue/WannaCry), and remote code execution. This port should never be exposed unless explicitly required for internal file sharing.',
        'RDP': 'RDP (Remote Desktop Protocol) is a high-value target for brute force attacks and credential stuffing. Exposed RDP has been the initial access vector in numerous ransomware campaigns. Access should be restricted to VPN-only or disabled entirely.',
        'Telnet': 'Telnet transmits all data including credentials in cleartext. Any network observer can intercept login sessions. This protocol has no legitimate use in modern environments and should be replaced with SSH.',
        'FTP': 'FTP transmits credentials and file data in cleartext. Attackers on the network can intercept sensitive files and authentication tokens. Replace with SFTP or FTPS for any file transfer needs.',
        'MySQL': 'Direct database access from the network enables data exfiltration, SQL injection exploitation, and unauthorized data modification. Database ports should only be accessible from application servers, never from the general network.',
        'PostgreSQL': 'Direct database access from the network enables data exfiltration, SQL injection exploitation, and unauthorized data modification. Database ports should only be accessible from application servers, never from the general network.',
        'MSSQL': 'Direct database access from the network enables data exfiltration, SQL injection exploitation, and unauthorized data modification. MSSQL exposes additional attack surface through xp_cmdshell and linked servers.',
        'HTTP': 'An unencrypted HTTP service may expose sensitive data in transit. If this is a web application, it should be migrated to HTTPS. If it is an internal service, access should be restricted.',
      };

      const risk = serviceRisks[service] || `Service "${service}" on port ${port} presents an unnecessary attack surface. Open ports expand the system\'s exposure to network-based attacks including service exploitation, brute force, and denial of service.`;
      const ruleName = `CEREBERUS_BLOCK_PORT_${port}`;

      return {
        designation: `Exposed ${service} Service`,
        attackVector: `Inbound TCP Port ${port}`,
        classification: v.severity.toUpperCase(),
        detectionMethod: `Local port scan \u2014 service responding on 0.0.0.0:${port}`,
        riskAssessment: risk,
        proposedAction: `Create Windows Firewall inbound block rule "${ruleName}" denying all TCP traffic on port ${port}. The service will remain installed but unreachable from the network.`,
        reversibility: 'FULL \u2014 Firewall rule can be removed to restore access. Rollback available via Remediation Action Log.',
      };
    }

    case 'guest_account':
      return {
        designation: 'Active Guest Account',
        attackVector: 'Local / Network Authentication',
        classification: v.severity.toUpperCase(),
        detectionMethod: 'Windows user account enumeration \u2014 Guest account status: active',
        riskAssessment: 'The Guest account provides unauthenticated access to system resources with minimal privileges. However, it can be leveraged for local privilege escalation, lateral movement within a network, and serves as an anonymous foothold for attackers who gain physical or network access.',
        proposedAction: 'Disable the Windows Guest account via "net user guest /active:no". The account will remain on the system but will reject all authentication attempts.',
        reversibility: 'FULL \u2014 Guest account can be re-enabled if needed. Rollback available via Remediation Action Log.',
      };

    case 'firewall':
      return {
        designation: 'Windows Firewall Disabled',
        attackVector: 'All Network Profiles (Domain/Private/Public)',
        classification: v.severity.toUpperCase(),
        detectionMethod: 'Firewall profile state check \u2014 one or more profiles reporting OFF',
        riskAssessment: 'With the firewall disabled, the system has no inbound traffic filtering. Every listening service is directly reachable from the network. This effectively negates all port-based security controls and exposes the system to the full range of network-based attacks.',
        proposedAction: 'Enable Windows Firewall on all profiles (Domain, Private, Public) via "netsh advfirewall set allprofiles state on". Existing firewall rules will be preserved and take effect immediately.',
        reversibility: 'FULL \u2014 Firewall can be disabled again if needed. Rollback available via Remediation Action Log.',
      };

    case 'autologin':
      return {
        designation: 'Auto-Login Enabled',
        attackVector: 'Physical Access / Local Exploitation',
        classification: v.severity.toUpperCase(),
        detectionMethod: 'Registry check \u2014 HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\AutoAdminLogon = 1',
        riskAssessment: 'Auto-login stores user credentials in plaintext in the Windows registry. Anyone with physical access to the machine gains immediate authenticated access without a password prompt. This also means credentials are readable by any process with registry access, enabling credential theft by malware.',
        proposedAction: 'Set AutoAdminLogon registry value to 0, disabling automatic login. The user will be prompted for credentials at the login screen on next boot.',
        reversibility: 'FULL \u2014 Auto-login can be re-enabled by setting the registry value back to 1. Rollback available via Remediation Action Log.',
      };

    case 'windows_update':
      return {
        designation: 'Outdated Windows Installation',
        attackVector: 'Multiple \u2014 Known CVE Exploitation',
        classification: v.severity.toUpperCase(),
        detectionMethod: 'Windows Update API check \u2014 pending security patches detected',
        riskAssessment: 'Missing security patches leave the system vulnerable to publicly known exploits. Attackers routinely scan for and exploit unpatched systems using automated tools. The risk compounds with each missed update as exploit code becomes widely available.',
        proposedAction: 'Manual intervention required. Open Settings > Update & Security > Windows Update and install all pending security updates. Automatic patching is not performed because it requires system reboots, may cause application compatibility issues, and could interrupt critical operations.',
        reversibility: 'PARTIAL \u2014 Updates can be uninstalled individually through Windows Update history, but this is not recommended.',
      };

    default:
      return {
        designation: v.title,
        attackVector: 'Unknown',
        classification: v.severity.toUpperCase(),
        detectionMethod: 'Automated scan',
        riskAssessment: v.description,
        proposedAction: v.remediation,
        reversibility: 'Unknown',
      };
  }
}

export function VulnerabilityPanel() {
  const [report, setReport] = useState<ScanReport | null>(null);
  const [scanning, setScanning] = useState(false);
  const [expandedIdx, setExpandedIdx] = useState<number | null>(null);
  const [neutralizationStates, setNeutralizationStates] = useState<Record<number, NeutralizationState>>({});

  useEffect(() => {
    loadReport();
  }, []);

  const loadReport = async () => {
    try {
      const data = await api.getVulnerabilityReport() as ScanReport;
      setReport(data);
    } catch { /* ignore */ }
  };

  const triggerScan = async () => {
    setScanning(true);
    try {
      const data = await api.triggerVulnerabilityScan() as ScanReport;
      setReport(data);
      setNeutralizationStates({});
      setExpandedIdx(null);
    } catch { /* ignore */ }
    setScanning(false);
  };

  const setNState = (idx: number, state: NeutralizationState) => {
    setNeutralizationStates((prev) => ({ ...prev, [idx]: state }));
  };

  const handleNeutralize = (globalIdx: number) => {
    setNState(globalIdx, { status: 'confirming' });
  };

  const handleStandDown = (globalIdx: number) => {
    setNState(globalIdx, { status: 'idle' });
  };

  const handleAuthorize = async (globalIdx: number, v: Vulnerability) => {
    setNState(globalIdx, { status: 'executing' });
    try {
      const result = await api.remediateVulnerability({
        category: v.category,
        port: v.port,
        service: v.service,
      }) as { success?: boolean; error?: string; output?: string; manual?: boolean; message?: string; rule_name?: string; action_id?: number };

      if (result.manual) {
        setNState(globalIdx, { status: 'failed', error: result.message || 'Manual intervention required' });
        return;
      }

      if (result.success) {
        const details = v.category === 'open_port'
          ? `Firewall rule ${result.rule_name || `CEREBERUS_BLOCK_PORT_${v.port}`} created`
          : v.category === 'guest_account'
            ? 'Guest account disabled'
            : v.category === 'firewall'
              ? 'Windows Firewall enabled on all profiles'
              : v.category === 'autologin'
                ? 'AutoAdminLogon set to 0'
                : 'Action completed';
        setNState(globalIdx, { status: 'neutralized', details });
        // Auto re-scan after 3s
        setTimeout(() => {
          triggerScan();
        }, 3000);
      } else {
        setNState(globalIdx, { status: 'failed', error: result.error || result.output || 'Remediation failed' });
      }
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Remediation failed';
      setNState(globalIdx, { status: 'failed', error: message });
    }
  };

  const handleRetry = (globalIdx: number) => {
    setNState(globalIdx, { status: 'idle' });
  };

  const severityColor = (s: string) => {
    const map: Record<string, string> = {
      critical: 'var(--severity-critical)',
      high: 'var(--severity-high)',
      medium: 'var(--severity-medium)',
      low: 'var(--severity-low)',
      info: 'var(--severity-info)',
    };
    return map[s] || 'var(--text-muted)';
  };

  const grouped = report ? groupBy(report.vulnerabilities, 'category') : {};

  const btnBase: React.CSSProperties = {
    padding: '8px 20px',
    border: 'none',
    borderRadius: '2px',
    fontSize: '11px',
    fontFamily: 'var(--font-mono)',
    letterSpacing: '2px',
    cursor: 'pointer',
    textTransform: 'uppercase' as const,
  };

  return (
    <IntelCard title="THREAT ASSESSMENT" classification="SECRET">
      {/* Header + Scan Button */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
        <div style={{ fontSize: '11px', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)', letterSpacing: '1px' }}>
          {report?.scan_time ? `LAST SCAN: ${new Date(report.scan_time).toLocaleTimeString('en-US', { hour12: false, timeZone: 'UTC' })} UTC` : 'NO SCAN DATA'}
        </div>
        <button
          onClick={triggerScan}
          disabled={scanning}
          style={{
            padding: '8px 20px',
            background: scanning ? 'var(--bg-tertiary)' : 'var(--red-dark)',
            border: `1px solid ${scanning ? 'var(--border-default)' : 'var(--red-primary)'}`,
            borderRadius: '2px',
            color: scanning ? 'var(--text-muted)' : '#fff',
            fontSize: '11px',
            fontFamily: 'var(--font-mono)',
            letterSpacing: '2px',
            cursor: scanning ? 'default' : 'pointer',
          }}
        >
          {scanning ? 'SCANNING...' : 'INITIATE THREAT SCAN'}
        </button>
      </div>

      {/* Severity Summary */}
      {report?.severity_counts && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px', marginBottom: '16px' }}>
          {['critical', 'high', 'medium', 'low'].map((sev) => (
            <div key={sev} className="instrument-readout">
              <span className="readout-label">{sev.toUpperCase()}</span>
              <span className="readout-value" style={{ color: severityColor(sev) }}>
                {report.severity_counts?.[sev] ?? 0}
              </span>
            </div>
          ))}
        </div>
      )}

      {/* Grouped Findings */}
      {Object.entries(grouped).map(([category, vulns], sectionIdx) => (
        <div key={category} style={{
          marginBottom: '12px',
          border: '1px solid var(--border-default)',
          borderRadius: '2px',
          overflow: 'hidden',
        }}>
          <div style={{
            padding: '10px 14px',
            background: 'var(--bg-tertiary)',
            borderBottom: '1px solid var(--border-default)',
            display: 'flex',
            justifyContent: 'space-between',
          }}>
            <span style={{
              fontSize: '11px',
              fontFamily: 'var(--font-mono)',
              fontWeight: 600,
              letterSpacing: '2px',
              color: 'var(--text-secondary)',
            }}>
              SECTION {toRoman(sectionIdx + 1)}: {category.toUpperCase().replace(/_/g, ' ')}
            </span>
            <span style={{ fontSize: '10px', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>
              {vulns.length} finding(s)
            </span>
          </div>
          {vulns.map((v: Vulnerability, i: number) => {
            const globalIdx = report!.vulnerabilities.indexOf(v);
            const isExpanded = expandedIdx === globalIdx;
            const stamp = SEVERITY_STAMPS[v.severity] || SEVERITY_STAMPS.info;
            const nState = neutralizationStates[globalIdx] || { status: 'idle' as const };
            const isRemediable = REMEDIABLE_CATEGORIES.includes(v.category);
            const isWindowsUpdate = v.category === 'windows_update';
            const briefing = getThreatBriefing(v);

            return (
              <div
                key={i}
                style={{
                  borderBottom: '1px solid var(--border-default)',
                }}
              >
                <div
                  onClick={() => setExpandedIdx(isExpanded ? null : globalIdx)}
                  style={{
                    padding: '8px 14px',
                    cursor: 'pointer',
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span className={`stamp-badge ${stamp.stampClass}`}>{stamp.label}</span>
                    <span style={{ fontSize: '12px', color: 'var(--text-primary)', flex: 1 }}>{v.title}</span>
                    {nState.status === 'neutralized' && (
                      <span style={{ fontSize: '9px', fontFamily: 'var(--font-mono)', letterSpacing: '1px', color: 'var(--status-online)' }}>NEUTRALIZED</span>
                    )}
                    <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>{isExpanded ? '\u25B2' : '\u25BC'}</span>
                  </div>
                </div>

                {isExpanded && (
                  <div style={{ padding: '0 14px 14px 14px' }}>
                    <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px', lineHeight: 1.5 }}>
                      {v.description}
                    </p>

                    {/* Recommended Action block */}
                    <div style={{
                      fontSize: '11px',
                      fontFamily: 'var(--font-mono)',
                      padding: '10px 14px',
                      background: 'var(--bg-tertiary)',
                      borderRadius: '2px',
                      borderLeft: '3px solid var(--cyan-dark)',
                      marginBottom: '12px',
                    }}>
                      <div style={{ fontSize: '9px', letterSpacing: '2px', color: 'var(--cyan-primary)', marginBottom: '4px' }}>
                        RECOMMENDED ACTION
                      </div>
                      <div style={{ color: 'var(--text-secondary)' }}>{v.remediation}</div>
                    </div>

                    {/* Neutralize button — idle state */}
                    {nState.status === 'idle' && (
                      <div style={{ marginTop: '8px' }}>
                        {isRemediable ? (
                          <button
                            onClick={(e) => { e.stopPropagation(); handleNeutralize(globalIdx); }}
                            style={{
                              ...btnBase,
                              background: 'var(--red-dark)',
                              border: '1px solid var(--red-primary)',
                              color: '#fff',
                            }}
                          >
                            NEUTRALIZE THREAT
                          </button>
                        ) : isWindowsUpdate ? (
                          <button
                            disabled
                            title="Windows Update requires manual intervention — reboots and compatibility checks cannot be automated safely"
                            style={{
                              ...btnBase,
                              background: 'var(--bg-tertiary)',
                              border: '1px solid var(--border-default)',
                              color: 'var(--text-muted)',
                              cursor: 'not-allowed',
                            }}
                          >
                            MANUAL INTERVENTION REQUIRED
                          </button>
                        ) : null}
                      </div>
                    )}

                    {/* Operational Briefing — confirming state */}
                    {nState.status === 'confirming' && (
                      <div style={{
                        marginTop: '12px',
                        border: '1px solid var(--border-default)',
                        borderRadius: '2px',
                        background: 'var(--bg-secondary)',
                        padding: '16px',
                      }}>
                        <div style={{
                          fontSize: '10px',
                          fontFamily: 'var(--font-mono)',
                          letterSpacing: '3px',
                          color: 'var(--cyan-primary)',
                          marginBottom: '16px',
                          borderBottom: '1px solid var(--border-default)',
                          paddingBottom: '8px',
                        }}>
                          OPERATIONAL BRIEFING
                        </div>

                        <div style={{ fontFamily: 'var(--font-mono)', fontSize: '11px', lineHeight: 2.2 }}>
                          {[
                            { label: 'THREAT DESIGNATION', value: briefing.designation },
                            { label: 'ATTACK VECTOR', value: briefing.attackVector },
                            { label: 'THREAT CLASSIFICATION', value: briefing.classification },
                            { label: 'DETECTION METHOD', value: briefing.detectionMethod },
                          ].map((field) => (
                            <div key={field.label} style={{ display: 'flex', gap: '24px' }}>
                              <span style={{ color: 'var(--text-muted)', minWidth: '200px', flexShrink: 0, fontSize: '10px', letterSpacing: '1px' }}>
                                {field.label}
                              </span>
                              <span style={{ color: 'var(--text-primary)' }}>{field.value}</span>
                            </div>
                          ))}
                        </div>

                        <div style={{ marginTop: '16px', marginBottom: '16px' }}>
                          <div style={{ fontSize: '10px', fontFamily: 'var(--font-mono)', letterSpacing: '1px', color: 'var(--text-muted)', marginBottom: '6px' }}>
                            RISK ASSESSMENT
                          </div>
                          <div style={{
                            fontSize: '11px',
                            fontFamily: 'var(--font-mono)',
                            color: 'var(--text-secondary)',
                            lineHeight: 1.7,
                            padding: '10px 14px',
                            background: 'var(--bg-tertiary)',
                            borderRadius: '2px',
                            borderLeft: '3px solid var(--amber-primary)',
                          }}>
                            {briefing.riskAssessment}
                          </div>
                        </div>

                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontSize: '10px', fontFamily: 'var(--font-mono)', letterSpacing: '1px', color: 'var(--text-muted)', marginBottom: '6px' }}>
                            PROPOSED ACTION
                          </div>
                          <div style={{
                            fontSize: '11px',
                            fontFamily: 'var(--font-mono)',
                            color: 'var(--text-secondary)',
                            lineHeight: 1.7,
                            padding: '10px 14px',
                            background: 'var(--bg-tertiary)',
                            borderRadius: '2px',
                            borderLeft: '3px solid var(--cyan-dark)',
                          }}>
                            {briefing.proposedAction}
                          </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                          <div style={{ fontSize: '10px', fontFamily: 'var(--font-mono)', letterSpacing: '1px', color: 'var(--text-muted)', marginBottom: '6px' }}>
                            REVERSIBILITY
                          </div>
                          <div style={{
                            fontSize: '11px',
                            fontFamily: 'var(--font-mono)',
                            color: 'var(--status-online)',
                            lineHeight: 1.7,
                          }}>
                            {briefing.reversibility}
                          </div>
                        </div>

                        <div style={{ display: 'flex', gap: '12px' }}>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleAuthorize(globalIdx, v); }}
                            style={{
                              ...btnBase,
                              background: 'var(--red-dark)',
                              border: '1px solid var(--red-primary)',
                              color: '#fff',
                            }}
                          >
                            AUTHORIZE ACTION
                          </button>
                          <button
                            onClick={(e) => { e.stopPropagation(); handleStandDown(globalIdx); }}
                            style={{
                              ...btnBase,
                              background: 'transparent',
                              border: '1px solid var(--border-active)',
                              color: 'var(--text-muted)',
                            }}
                          >
                            STAND DOWN
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Executing state */}
                    {nState.status === 'executing' && (
                      <div style={{ marginTop: '12px' }}>
                        <div style={{
                          fontSize: '11px',
                          fontFamily: 'var(--font-mono)',
                          letterSpacing: '2px',
                          color: 'var(--red-primary)',
                          marginBottom: '8px',
                        }}>
                          EXECUTING...
                        </div>
                        <div style={{
                          height: '2px',
                          background: 'var(--bg-tertiary)',
                          borderRadius: '1px',
                          overflow: 'hidden',
                        }}>
                          <div className="sweep-progress" />
                        </div>
                      </div>
                    )}

                    {/* Neutralized state */}
                    {nState.status === 'neutralized' && (
                      <div className="threat-neutralized" style={{
                        marginTop: '12px',
                        padding: '10px 14px',
                        fontFamily: 'var(--font-mono)',
                        fontSize: '11px',
                      }}>
                        <div style={{ letterSpacing: '2px', marginBottom: '4px', fontWeight: 600 }}>
                          THREAT NEUTRALIZED
                        </div>
                        <div style={{ color: 'var(--text-secondary)', fontSize: '10px' }}>
                          {nState.details}
                        </div>
                      </div>
                    )}

                    {/* Failed state */}
                    {nState.status === 'failed' && (
                      <div style={{ marginTop: '12px' }}>
                        <div className="threat-failed" style={{
                          padding: '10px 14px',
                          fontFamily: 'var(--font-mono)',
                          fontSize: '11px',
                        }}>
                          <div style={{ letterSpacing: '2px', marginBottom: '4px', fontWeight: 600 }}>
                            REMEDIATION FAILED
                          </div>
                          <div style={{ color: 'var(--text-secondary)', fontSize: '10px' }}>
                            {nState.error}
                          </div>
                        </div>
                        <button
                          onClick={(e) => { e.stopPropagation(); handleRetry(globalIdx); }}
                          style={{
                            ...btnBase,
                            marginTop: '8px',
                            background: 'var(--red-dark)',
                            border: '1px solid var(--red-primary)',
                            color: '#fff',
                          }}
                        >
                          RETRY
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      ))}

      {report && report.vulnerabilities.length === 0 && (
        <div style={{
          textAlign: 'center',
          padding: '40px',
          color: 'var(--status-online)',
          fontFamily: 'var(--font-mono)',
          fontSize: '12px',
          letterSpacing: '2px',
        }}>
          NO VULNERABILITIES DETECTED
        </div>
      )}
    </IntelCard>
  );
}

function toRoman(n: number): string {
  const numerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
  return numerals[n - 1] || String(n);
}

function groupBy<T>(arr: T[], key: keyof T): Record<string, T[]> {
  const result: Record<string, T[]> = {};
  for (const item of arr) {
    const k = String(item[key]);
    if (!result[k]) result[k] = [];
    result[k].push(item);
  }
  return result;
}
