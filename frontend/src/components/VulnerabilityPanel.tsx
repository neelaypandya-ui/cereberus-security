import { useEffect, useState } from 'react';
import { api } from '../services/api';

interface Vulnerability {
  category: string;
  severity: string;
  title: string;
  description: string;
  remediation: string;
  port?: number;
  service?: string;
}

interface ScanReport {
  scan_time?: string;
  total_findings: number;
  severity_counts?: Record<string, number>;
  vulnerabilities: Vulnerability[];
}

export function VulnerabilityPanel() {
  const [report, setReport] = useState<ScanReport | null>(null);
  const [scanning, setScanning] = useState(false);
  const [expandedIdx, setExpandedIdx] = useState<number | null>(null);

  useEffect(() => {
    loadReport();
  }, []);

  const loadReport = async () => {
    try {
      const data = await api.getVulnerabilityReport() as ScanReport;
      setReport(data);
    } catch { /* ignore */ }
  };

  const triggerScan = async () => {
    setScanning(true);
    try {
      const data = await api.triggerVulnerabilityScan() as ScanReport;
      setReport(data);
    } catch { /* ignore */ }
    setScanning(false);
  };

  const severityColor = (s: string) => {
    const map: Record<string, string> = {
      critical: 'var(--severity-critical)',
      high: 'var(--severity-high)',
      medium: 'var(--severity-medium)',
      low: 'var(--severity-low)',
      info: 'var(--severity-info)',
    };
    return map[s] || 'var(--text-muted)';
  };

  const grouped = report ? groupBy(report.vulnerabilities, 'category') : {};

  return (
    <div>
      {/* Header + Scan Button */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
        <div style={{ fontSize: '12px', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>
          {report?.scan_time ? `Last scan: ${new Date(report.scan_time).toLocaleString()}` : 'No scan yet'}
        </div>
        <button
          onClick={triggerScan}
          disabled={scanning}
          style={{
            padding: '8px 20px',
            background: scanning ? 'var(--bg-tertiary)' : 'var(--red-dark)',
            border: '1px solid var(--red-primary)',
            borderRadius: '6px',
            color: 'var(--text-primary)',
            fontSize: '12px',
            cursor: scanning ? 'default' : 'pointer',
            fontFamily: 'var(--font-mono)',
            letterSpacing: '1px',
          }}
        >
          {scanning ? 'SCANNING...' : 'RUN SCAN'}
        </button>
      </div>

      {/* Severity Summary Cards */}
      {report?.severity_counts && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: '12px', marginBottom: '20px' }}>
          {['critical', 'high', 'medium', 'low'].map((sev) => (
            <div key={sev} className="glow-card">
              <div style={{ fontSize: '10px', color: 'var(--text-muted)', letterSpacing: '1px', marginBottom: '6px' }}>
                {sev.toUpperCase()}
              </div>
              <div style={{
                fontSize: '24px',
                fontWeight: 700,
                fontFamily: 'var(--font-mono)',
                color: severityColor(sev),
              }}>
                {report.severity_counts?.[sev] ?? 0}
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Grouped Findings */}
      {Object.entries(grouped).map(([category, vulns]) => (
        <div key={category} style={{
          marginBottom: '16px',
          background: 'var(--bg-card)',
          border: '1px solid var(--border-default)',
          borderRadius: '8px',
          overflow: 'hidden',
        }}>
          <div style={{
            padding: '12px 16px',
            background: 'var(--bg-tertiary)',
            borderBottom: '1px solid var(--border-default)',
            display: 'flex',
            justifyContent: 'space-between',
          }}>
            <span style={{ fontSize: '12px', fontWeight: 600, letterSpacing: '1px' }}>
              {category.toUpperCase().replace(/_/g, ' ')}
            </span>
            <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>
              {vulns.length} finding(s)
            </span>
          </div>
          {vulns.map((v: Vulnerability, i: number) => {
            const globalIdx = report!.vulnerabilities.indexOf(v);
            const isExpanded = expandedIdx === globalIdx;
            return (
              <div
                key={i}
                onClick={() => setExpandedIdx(isExpanded ? null : globalIdx)}
                style={{
                  padding: '10px 16px',
                  borderBottom: '1px solid var(--border-default)',
                  cursor: 'pointer',
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <span style={{
                    fontSize: '9px',
                    fontWeight: 700,
                    color: severityColor(v.severity),
                    textTransform: 'uppercase',
                    minWidth: '55px',
                    padding: '2px 6px',
                    borderRadius: '3px',
                    background: `${severityColor(v.severity)}15`,
                  }}>
                    {v.severity}
                  </span>
                  <span style={{ fontSize: '12px', color: 'var(--text-primary)', flex: 1 }}>
                    {v.title}
                  </span>
                  <span style={{ fontSize: '11px', color: 'var(--text-muted)' }}>
                    {isExpanded ? '\u25B2' : '\u25BC'}
                  </span>
                </div>
                {isExpanded && (
                  <div style={{ marginTop: '10px', paddingLeft: '67px' }}>
                    <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                      {v.description}
                    </p>
                    <div style={{
                      fontSize: '11px',
                      color: 'var(--cyan-primary)',
                      fontFamily: 'var(--font-mono)',
                      padding: '8px 12px',
                      background: 'var(--bg-tertiary)',
                      borderRadius: '4px',
                      borderLeft: '3px solid var(--cyan-dark)',
                    }}>
                      {v.remediation}
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      ))}

      {report && report.vulnerabilities.length === 0 && (
        <div style={{
          textAlign: 'center',
          padding: '40px',
          color: 'var(--status-online)',
          fontFamily: 'var(--font-mono)',
          fontSize: '13px',
        }}>
          No vulnerabilities detected
        </div>
      )}
    </div>
  );
}

function groupBy<T>(arr: T[], key: keyof T): Record<string, T[]> {
  const result: Record<string, T[]> = {};
  for (const item of arr) {
    const k = String(item[key]);
    if (!result[k]) result[k] = [];
    result[k].push(item);
  }
  return result;
}
