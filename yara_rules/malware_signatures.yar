/*
    Cereberus YARA Rules - Malware Signatures
    Detects PE header anomalies, known backdoor patterns, shellcode indicators,
    and common malware tooling artifacts.
*/

import "pe"
import "math"

// ---------------------------------------------------------------------------
// PE Header Anomalies
// ---------------------------------------------------------------------------

rule PE_Suspicious_Section_Names {
    meta:
        author = "Cereberus"
        description = "Detects PE files with suspicious or obfuscated section names commonly used by packers and malware"
        severity = "medium"
        mitre_technique = "T1027"
        category = "packer"
    strings:
        $sect1 = ".ndata" ascii
        $sect2 = "UPX0" ascii
        $sect3 = "UPX1" ascii
        $sect4 = ".aspack" ascii
        $sect5 = ".adata" ascii
        $sect6 = ".packed" ascii
        $sect7 = "MEW" ascii
        $sect8 = ".themida" ascii
        $sect9 = ".vmp0" ascii
        $sect10 = ".vmp1" ascii
        $sect11 = "nsp0" ascii
        $sect12 = ".enigma1" ascii
        $sect13 = ".petite" ascii
    condition:
        uint16(0) == 0x5A4D and any of ($sect*)
}

rule PE_Abnormal_Entropy {
    meta:
        author = "Cereberus"
        description = "Detects PE files with high entropy suggesting encryption or packing"
        severity = "medium"
        mitre_technique = "T1027.002"
        category = "obfuscation"
    condition:
        uint16(0) == 0x5A4D and
        math.entropy(0, filesize) > 7.2
}

rule PE_No_Import_Table {
    meta:
        author = "Cereberus"
        description = "Detects PE files with no or minimal imports, common in shellcode loaders and packed malware"
        severity = "high"
        mitre_technique = "T1027.002"
        category = "loader"
    condition:
        uint16(0) == 0x5A4D and
        pe.number_of_imports == 0
}

rule PE_Suspicious_Timestamp {
    meta:
        author = "Cereberus"
        description = "Detects PE files with a compilation timestamp in the future or set to zero (timestomping)"
        severity = "low"
        mitre_technique = "T1070.006"
        category = "timestomp"
    condition:
        uint16(0) == 0x5A4D and
        (pe.timestamp == 0 or pe.timestamp > 2147483647)
}

rule PE_Double_Extension_Executable {
    meta:
        author = "Cereberus"
        description = "Detects executables that may have been disguised with double extensions"
        severity = "medium"
        mitre_technique = "T1036.007"
        category = "masquerading"
    strings:
        $ext1 = ".pdf.exe" nocase
        $ext2 = ".doc.exe" nocase
        $ext3 = ".jpg.exe" nocase
        $ext4 = ".png.exe" nocase
        $ext5 = ".txt.exe" nocase
        $ext6 = ".xlsx.exe" nocase
        $ext7 = ".mp4.exe" nocase
        $ext8 = ".pdf.scr" nocase
        $ext9 = ".doc.scr" nocase
    condition:
        uint16(0) == 0x5A4D and any of ($ext*)
}

// ---------------------------------------------------------------------------
// Backdoor Detection
// ---------------------------------------------------------------------------

rule Backdoor_Generic_CmdExec {
    meta:
        author = "Cereberus"
        description = "Detects common backdoor command execution patterns"
        severity = "high"
        mitre_technique = "T1059.003"
        category = "backdoor"
    strings:
        $cmd1 = "cmd.exe /c" nocase
        $cmd2 = "cmd /c" nocase
        $cmd3 = "command.com /c" nocase
        $ps1 = "powershell -e" nocase
        $ps2 = "powershell -enc" nocase
        $ps3 = "powershell -encodedcommand" nocase
        $ps4 = "powershell -nop -w hidden" nocase
        $ps5 = "powershell -noprofile" nocase
        $ps6 = "powershell.exe -ep bypass" nocase
        $ps7 = "IEX(New-Object Net.WebClient)" nocase
        $ps8 = "Invoke-Expression" nocase
        $wmi1 = "wmic process call create" nocase
        $wmi2 = "Win32_Process" nocase
        $net1 = "net user /add" nocase
        $net2 = "net localgroup administrators" nocase
        $net3 = "net start" nocase
    condition:
        3 of them
}

rule Backdoor_Reverse_Shell {
    meta:
        author = "Cereberus"
        description = "Detects indicators of reverse shell functionality"
        severity = "critical"
        mitre_technique = "T1059"
        category = "backdoor"
    strings:
        $sock1 = "WSAStartup" ascii
        $sock2 = "WSASocketA" ascii
        $sock3 = "connect" ascii
        $sock4 = "CreateProcessA" ascii
        $sock5 = "SOCK_STREAM" ascii
        $pipe1 = "CreatePipe" ascii
        $pipe2 = "PeekNamedPipe" ascii
        $sh1 = "/bin/sh" ascii
        $sh2 = "/bin/bash" ascii
        $sh3 = "cmd.exe" ascii wide
        $rev1 = "reverse_tcp" ascii
        $rev2 = "reverse_shell" ascii
        $rev3 = "bind_shell" ascii
        $rev4 = "meterpreter" ascii nocase
    condition:
        (2 of ($sock*) and 1 of ($pipe*) and 1 of ($sh*)) or
        2 of ($rev*)
}

rule Backdoor_Cobalt_Strike_Beacon {
    meta:
        author = "Cereberus"
        description = "Detects Cobalt Strike Beacon indicators in memory or on disk"
        severity = "critical"
        mitre_technique = "T1071.001"
        category = "c2"
    strings:
        $cfg1 = { 00 01 00 01 00 02 ?? ?? 00 02 00 01 00 02 ?? ?? }
        $cfg2 = { 00 01 00 02 00 04 ?? ?? ?? ?? 00 02 00 02 00 04 }
        $str1 = "%s.4444" ascii
        $str2 = "beacon.dll" ascii
        $str3 = "beacon.x64.dll" ascii
        $str4 = "ReflectiveLoader" ascii
        $str5 = "%02d/%02d/%02d %02d:%02d:%02d" ascii
        $pipe1 = "\\\\.\\pipe\\msagent_" ascii
        $pipe2 = "\\\\.\\pipe\\MSSE-" ascii
        $ua1 = "Mozilla/5.0 (compatible; MSIE" ascii
        $named1 = "\\\\%s\\pipe\\%s" ascii
    condition:
        3 of them
}

rule Backdoor_Meterpreter_Indicators {
    meta:
        author = "Cereberus"
        description = "Detects Meterpreter payload indicators"
        severity = "critical"
        mitre_technique = "T1059.006"
        category = "c2"
    strings:
        $api1 = "stdapi_" ascii
        $api2 = "core_channel_open" ascii
        $api3 = "core_channel_write" ascii
        $api4 = "core_channel_read" ascii
        $api5 = "core_loadlib" ascii
        $str1 = "metsrv.dll" ascii
        $str2 = "ext_server_" ascii
        $str3 = "post/multi/" ascii
        $byte1 = { 4D 5A 52 45 } // MZRE header variant
        $byte2 = { 6D 65 74 73 72 76 } // "metsrv"
    condition:
        3 of them
}

rule Backdoor_RAT_Indicators {
    meta:
        author = "Cereberus"
        description = "Detects common Remote Access Trojan indicators"
        severity = "high"
        mitre_technique = "T1219"
        category = "rat"
    strings:
        $key1 = "keylogger" ascii nocase
        $key2 = "GetAsyncKeyState" ascii
        $key3 = "SetWindowsHookEx" ascii
        $screen1 = "screenshot" ascii nocase
        $screen2 = "ScreenCapture" ascii nocase
        $screen3 = "BitBlt" ascii
        $cam1 = "webcam" ascii nocase
        $cam2 = "capCreateCaptureWindow" ascii
        $file1 = "FileManager" ascii
        $file2 = "UploadFile" ascii nocase
        $file3 = "DownloadFile" ascii nocase
        $persist1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $persist2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" nocase
    condition:
        uint16(0) == 0x5A4D and 4 of them
}

// ---------------------------------------------------------------------------
// Shellcode Indicators
// ---------------------------------------------------------------------------

rule Shellcode_x86_NOP_Sled {
    meta:
        author = "Cereberus"
        description = "Detects x86 NOP sleds commonly preceding shellcode"
        severity = "high"
        mitre_technique = "T1055"
        category = "shellcode"
    strings:
        $nop20 = { 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 }
    condition:
        $nop20
}

rule Shellcode_Common_Stubs {
    meta:
        author = "Cereberus"
        description = "Detects common shellcode API resolution stubs (PEB walking, hash-based resolution)"
        severity = "critical"
        mitre_technique = "T1055.001"
        category = "shellcode"
    strings:
        // PEB access via fs:[0x30] (x86)
        $peb32 = { 64 A1 30 00 00 00 }
        // PEB access via gs:[0x60] (x64)
        $peb64 = { 65 48 8B 04 25 60 00 00 00 }
        // Typical kernel32 hash resolution loop
        $hash_loop = { 8B 40 0C 8B 70 1C AD 8B 68 08 }
        // ROR13 hash resolution (Metasploit style)
        $ror13 = { C1 CF 0D 01 C7 }
        // Common LoadLibraryA + GetProcAddress pattern
        $loadlib = { 68 ?? ?? ?? ?? FF 15 ?? ?? ?? ?? 68 ?? ?? ?? ?? 50 FF 15 }
    condition:
        any of them
}

rule Shellcode_Egg_Hunter {
    meta:
        author = "Cereberus"
        description = "Detects egg hunter shellcode patterns used in exploit payloads"
        severity = "critical"
        mitre_technique = "T1203"
        category = "shellcode"
    strings:
        // NtAccessCheckAndAuditAlarm egg hunter (x86)
        $egg1 = { 66 81 CA FF 0F 42 52 6A 02 58 CD 2E 3C 05 5A 74 }
        // SEH-based egg hunter
        $egg2 = { EB 21 59 B8 ?? ?? ?? ?? 51 6A FF }
        // NtDisplayString egg hunter
        $egg3 = { 66 81 CA FF 0F 42 52 6A 43 58 CD 2E 3C 05 5A 74 }
    condition:
        any of them
}

rule Shellcode_Process_Injection_APIs {
    meta:
        author = "Cereberus"
        description = "Detects combination of Windows API calls commonly used for process injection"
        severity = "critical"
        mitre_technique = "T1055.001"
        category = "injection"
    strings:
        $api1 = "VirtualAllocEx" ascii
        $api2 = "WriteProcessMemory" ascii
        $api3 = "CreateRemoteThread" ascii
        $api4 = "NtCreateThreadEx" ascii
        $api5 = "RtlCreateUserThread" ascii
        $api6 = "OpenProcess" ascii
        $api7 = "VirtualProtectEx" ascii
        $api8 = "NtMapViewOfSection" ascii
        $api9 = "QueueUserAPC" ascii
        $api10 = "NtQueueApcThread" ascii
        $api11 = "SetThreadContext" ascii
    condition:
        uint16(0) == 0x5A4D and
        ($api6 and $api1 and $api2 and ($api3 or $api4 or $api5)) or
        ($api6 and $api8) or
        ($api6 and $api9 and $api2) or
        ($api6 and $api11 and $api7)
}

// ---------------------------------------------------------------------------
// Credential / Token Theft Tools
// ---------------------------------------------------------------------------

rule Tool_Mimikatz_Indicators {
    meta:
        author = "Cereberus"
        description = "Detects Mimikatz credential dumping tool and its variants"
        severity = "critical"
        mitre_technique = "T1003.001"
        category = "credential_theft"
    strings:
        $str1 = "mimikatz" ascii nocase
        $str2 = "gentilkiwi" ascii
        $str3 = "sekurlsa::" ascii
        $str4 = "kerberos::" ascii
        $str5 = "crypto::" ascii
        $str6 = "dpapi::" ascii
        $str7 = "lsadump::" ascii
        $str8 = "privilege::debug" ascii
        $str9 = "token::elevate" ascii
        $str10 = "mimilib.dll" ascii
        $str11 = "mimidrv.sys" ascii
        $byte1 = { 6D 00 69 00 6D 00 69 00 6B 00 61 00 74 00 7A } // "mimikatz" wide
    condition:
        2 of them
}

rule Tool_LaZagne_Indicators {
    meta:
        author = "Cereberus"
        description = "Detects LaZagne password recovery tool"
        severity = "high"
        mitre_technique = "T1555"
        category = "credential_theft"
    strings:
        $str1 = "lazagne" ascii nocase
        $str2 = "AlessandroZ" ascii
        $str3 = "softwares.browsers" ascii
        $str4 = "softwares.sysadmin" ascii
        $str5 = "softwares.wifi" ascii
        $str6 = "softwares.mail" ascii
        $str7 = "print_output" ascii
        $str8 = "manage_advanced_options" ascii
    condition:
        3 of them
}

// ---------------------------------------------------------------------------
// Living Off The Land / LOLBin Abuse
// ---------------------------------------------------------------------------

rule LOLBin_Suspicious_Execution {
    meta:
        author = "Cereberus"
        description = "Detects suspicious use of Windows LOLBins for execution or download"
        severity = "high"
        mitre_technique = "T1218"
        category = "lolbin"
    strings:
        $lol1 = "mshta.exe" ascii nocase
        $lol2 = "mshta vbscript:" nocase
        $lol3 = "regsvr32 /s /n /u /i:" nocase
        $lol4 = "regsvr32.exe /s /n" nocase
        $lol5 = "certutil -urlcache" nocase
        $lol6 = "certutil -decode" nocase
        $lol7 = "certutil -encode" nocase
        $lol8 = "bitsadmin /transfer" nocase
        $lol9 = "bitsadmin /create" nocase
        $lol10 = "rundll32.exe javascript:" nocase
        $lol11 = "cmstp.exe /ni /s" nocase
        $lol12 = "msxsl.exe" ascii nocase
        $lol13 = "wmic process call create" nocase
        $lol14 = "forfiles /p" nocase
        $lol15 = "pcalua.exe -a" nocase
        $lol16 = "SyncAppvPublishingServer.exe" nocase
    condition:
        2 of them
}

// ---------------------------------------------------------------------------
// Packed / Crypted Malware
// ---------------------------------------------------------------------------

rule Packed_Executable_Indicators {
    meta:
        author = "Cereberus"
        description = "Detects executables with packing or crypter indicators beyond section names"
        severity = "medium"
        mitre_technique = "T1027.002"
        category = "packer"
    strings:
        $upx1 = "UPX!" ascii
        $upx2 = "UPX0" ascii
        $aspack = ".aspack" ascii
        $pec1 = "PECompact2" ascii
        $petite = ".petite" ascii
        $mpress = ".MPRESS1" ascii
        $nspack = "nsPack" ascii
        $fsg = "FSG!" ascii
    condition:
        uint16(0) == 0x5A4D and
        any of them and
        math.entropy(0, filesize) > 6.8
}
